ğŸŒ PLANO OFICIAL DE IMPLEMENTAÃ‡ÃƒO â€” Sistema de NotificaÃ§Ãµes Por Raio + Afinidade

Projeto: Partiu
Data: 6 de dezembro de 2025
Objetivo: Notificar usuÃ¡rios relevantes quando uma atividade Ã© criada, esquentando ou atualizada.

1. Problema Atual

- Triggers hoje fazem tudo:

- query geogrÃ¡fica

- cÃ¡lculo de distÃ¢ncia

- business logic

- montagem de texto

- criaÃ§Ã£o da notificaÃ§Ã£o

**Isso gera:**

- alta complexidade

- dificuldade de testes

- inconsistÃªncia

- alto consumo de Firestore

- risco de SPAM (notificaÃ§Ã£o irrelevante)

2. Nova Arquitetura em 4 Camadas

Essa arquitetura separa responsabilidades e permite escalonar para Cloud Functions no futuro:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAMADA 0 â€” Infra: GeoIndex    â”‚
â”‚  â†’ Busca usuÃ¡rios no raio     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAMADA 1 â€” Afinidade          â”‚
â”‚  â†’ Interesses em comum        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAMADA 2 â€” Targeting          â”‚
â”‚  â†’ Quem deve receber           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAMADA 3 â€” Orchestrator       â”‚
â”‚  â†’ CriaÃ§Ã£o em batch           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAMADA 4 â€” Trigger            â”‚
â”‚  â†’ Apenas dispara              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Nova Regra de NegÃ³cio Importante
ğŸš« NÃƒO notificar todos os usuÃ¡rios no raio.
ğŸ¯ SIM notificar apenas:

UsuÃ¡rios dentro do raio de 30km

Que possuem pelo menos um interesse em comum com o criador da atividade

Isso reduz SPAM e aumenta relevÃ¢ncia.

4. Camadas em Detalhes
CAMADA 0 â€” GeoIndexService

Arquivo:
lib/core/services/geo_index_service.dart

ResponsÃ¡vel por:

bounding box

queries geogrÃ¡ficas

cÃ¡lculos de distÃ¢ncia

paginaÃ§Ã£o para grandes volumes

Retorno:
List<String> de userIds dentro do raio.

CAMADA 1 â€” UserAffinityService

Arquivo:
lib/features/notifications/services/user_affinity_service.dart

ResponsÃ¡vel por:

buscar interesses do criador

buscar interesses de usuÃ¡rios no raio

calcular interseÃ§Ã£o

ordenar por relevÃ¢ncia

Retorno:
Map<userId, List<String>> â†’ afinidade por usuÃ¡rio.

CAMADA 2 â€” NotificationTargetingService

Arquivo:
lib/features/notifications/services/notification_targeting_service.dart

ResponsÃ¡vel por decidir quem recebe a notificaÃ§Ã£o.

Exemplos:

activity_created â†’ geo + afinidade

heating_up â†’ somente participantes

join_request â†’ criador

join_approved â†’ solicitante

CAMADA 3 â€” NotificationOrchestrator

Arquivo:
lib/features/notifications/services/notification_orchestrator.dart

ResponsÃ¡vel por:

criar documentos na coleÃ§Ã£o Notifications

batch writes de atÃ© 500

enriquecer notificaÃ§Ãµes com dados como afinidade, emoji etc.

CAMADA 4 â€” Trigger

Arquivo:
activity_created_trigger.dart

Trigger agora:

NÃƒO faz cÃ¡lculo geogrÃ¡fico

NÃƒO busca interesses

NÃƒO cria texto de notificaÃ§Ã£o

NÃƒO cria documento Firestore

Ele faz apenas:

final targets = await targetingService.getUsersForActivityCreated(activity);
final creator = await userRepo.getUserById(activity.createdBy);

await orchestrator.createActivityCreatedNotifications(
  activity: activity,
  affinityMap: targets,
  creator: creator,
);


Simples, limpo, testÃ¡vel.

5. Fluxo Completo â€” Atividade Criada
Trigger
  â†“
TargetingService
  â†“
GeoIndexService â†’ lista usuÃ¡rios no raio
  â†“
UserAffinityService â†’ filtra por interesses
  â†“
TargetingService â†’ retorna mapa final userId â†’ interessesEmComum
  â†“
Orchestrator â†’ batch write (500+500 etc)
  â†“
Firestore Notifications

6. Melhorias TÃ©cnicas de Performance
Bounding Box (reduz Firestore em atÃ© 80%)
PaginaÃ§Ã£o para consulta de milhares de usuÃ¡rios
Batch Writes (atÃ© 500 operaÃ§Ãµes por commit)
Logs estruturados para debug
7. PadronizaÃ§Ã£o dos Textos das NotificaÃ§Ãµes

Todo trigger deve usar o NotificationTemplateEngine, nunca templates manuais.

Arquivos sugeridos:

lib/features/notifications/templates/notification_templates.dart


A trigger nÃ£o escreve texto.
Ela chama:

final template = NotificationTemplates.activityCreated(
  creatorName: creator.fullName,
  activityName: activity.name,
  emoji: activity.emoji,
  commonInterests: commonInterests,
);

8. Checklist de Arquitetura
Criar:

âœ” GeoIndexService
âœ” UserAffinityService
âœ” NotificationTargetingService
âœ” NotificationOrchestrator
âœ” NotificationTemplateEngine (modelo)
âœ” trigger minimalista

Atualizar:

âœ” ActivityCreatedTrigger
âœ” ActivityHeatingUpTrigger
âœ” Outros triggers

Garantir:

âœ” DI com GetIt
âœ” Testes unitÃ¡rios por camada
âœ” Logs estruturados

9. Checklist de Deploy

Criar serviÃ§os (camadas 0-3)

Alterar triggers

Atualizar DI

Testar atividade criada com 10, 100, 500 usuÃ¡rios simulados

Verificar batch writes

Validar no app:

notificaÃ§Ãµes aparecem

textos padronizados

navegaÃ§Ã£o consistente

10. Resultado Final Esperado
Antes

Muitas notificaÃ§Ãµes irrelevantes

Sistema confuso, difÃ­cil de testar

CÃ³digo duplicado

Trigger enorme e pouco escalÃ¡vel

Depois

ğŸ‘¥ NotificaÃ§Ãµes hiper relevantes

ğŸ“¦ Arquitetura modular e testÃ¡vel

ğŸš€ Melhor performance

ğŸ”„ Pronto para migrar para Cloud Functions

ğŸ“ CÃ³digo limpo e padronizado

ğŸ“£ NotificaÃ§Ãµes ricas com afinidade (â€œvocÃªs combinam em Xâ€)
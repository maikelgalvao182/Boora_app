/// üîë Cole√ß√£o de tokens FCM para push notifications
/// Path usado no app:
/// - DeviceTokens/{tokenId}
///   - userId: string (ID do usu√°rio dono do token)
///   - token: string (FCM token)
///   - deviceId: string (ID √∫nico do dispositivo)
///   - deviceName: string (nome do dispositivo)
///   - platform: string ("android" | "ios")
///   - createdAt: timestamp
///   - updatedAt: timestamp
///   - lastUsedAt: timestamp
///
/// Regras:
/// - Usu√°rio pode ler apenas seus pr√≥prios tokens
/// - Usu√°rio pode criar/atualizar apenas seus pr√≥prios tokens
/// - Usu√°rio pode deletar apenas seus pr√≥prios tokens
/// - Cloud Functions podem ler/escrever em qualquer token

match /DeviceTokens/{tokenId} {
  /// üìñ LEITURA:
  /// - Permite ler se o documento n√£o existe (para verificar antes de criar)
  /// - Permite ler se √© o dono do token
  allow read: if isSignedIn() && 
    (!exists(/databases/$(database)/documents/DeviceTokens/$(tokenId)) || 
     resource.data.userId == request.auth.uid);
  
  /// ‚úçÔ∏è CRIAR token:
  /// - userId deve ser o usu√°rio autenticado
  /// - Validar campos obrigat√≥rios (permite campos adicionais como timestamps)
  /// - Validar plataforma
  allow create: if isSignedIn() && 
    request.resource.data.userId == request.auth.uid &&
    request.resource.data.userId is string &&
    request.resource.data.token is string &&
    request.resource.data.deviceId is string &&
    request.resource.data.deviceName is string &&
    request.resource.data.platform is string &&
    request.resource.data.platform in ['android', 'ios'];
  
  /// ‚úèÔ∏è ATUALIZAR token:
  /// - Apenas o dono pode atualizar
  /// - N√£o pode mudar userId
  allow update: if isSignedIn() && 
    resource.data.userId == request.auth.uid &&
    request.resource.data.userId == resource.data.userId;
  
  /// üóëÔ∏è DELETAR token:
  /// - Apenas o dono pode deletar
  allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
}

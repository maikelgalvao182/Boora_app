/// üé≠ Cole√ß√£o de verifica√ß√µes faciais/ID com Didit
/// Path usado no app:
/// - FaceVerifications/{userId}
///   - facialId: string (session_id do Didit)
///   - verificationType: string ("didit")
///   - verifiedAt: timestamp
///   - userInfo: map (dados extra√≠dos)

match /FaceVerifications/{userId} {
  // Usu√°rio pode ler apenas sua pr√≥pria verifica√ß√£o
  allow read: if isOwner(userId);
  
  // Usu√°rio pode criar/atualizar apenas sua pr√≥pria verifica√ß√£o
  allow create, update: if isOwner(userId);
  
  // Cloud Functions podem criar verifica√ß√µes (webhook do Didit)
  allow create: if true;
  
  // N√£o permite deletar verifica√ß√µes (auditoria)
  allow delete: if false;
}

/// üìã Cole√ß√£o de sess√µes de verifica√ß√£o Didit
/// Path usado no app:
/// - DiditSessions/{sessionId}
///   - sessionId: string
///   - userId: string
///   - url: string
///   - workflowId: string
///   - status: string
///   - createdAt: timestamp
///   - vendorData: string

match /DiditSessions/{sessionId} {
  // Usu√°rio pode criar suas pr√≥prias sess√µes
  allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
  
  // Usu√°rio pode ler suas pr√≥prias sess√µes (verifica se existe primeiro)
  allow read: if isSignedIn() && (
    resource == null || // Documento n√£o existe ainda
    resource.data.userId == request.auth.uid // Ou pertence ao usu√°rio
  );
  
  // Cloud Functions podem atualizar campos espec√≠ficos de status
  allow update: if request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['status', 'completedAt', 'result', 'lastWebhookType', 'lastWebhookAt']);
  
  // N√£o permite deletar sess√µes (auditoria)
  allow delete: if false;
}

/// üì® Cole√ß√£o de webhooks recebidos do Didit
/// Path usado no app:
/// - DiditWebhooks/{webhookId}
///   - sessionId: string
///   - webhookType: string
///   - decision: map
///   - idVerification: map
///   - receivedAt: timestamp
///
/// üîí SEGURAN√áA:
/// - Create: permitido sem autentica√ß√£o (vem do servidor Didit)
/// - ‚ö†Ô∏è Valida√ß√£o de signature acontece no backend (Cloud Function)
/// - Leitura: apenas via console/backend (Admin SDK)

match /DiditWebhooks/{webhookId} {
  /// üìñ LEITURA:
  /// - Bloqueada para usu√°rios normais (dados sens√≠veis)
  /// - Apenas admins via console/backend
  allow read: if false;
  
  /// ‚úçÔ∏è CRIAR webhook:
  /// - Permitido sem auth (servidor Didit n√£o tem token Firebase)
  /// - Valida√ß√£o de signature acontece na Cloud Function
  /// - Campos obrigat√≥rios validados
  allow create: if request.resource.data.keys().hasAll(['sessionId', 'webhookType', 'receivedAt']);
  
  /// ‚úèÔ∏è ATUALIZAR webhook:
  /// - Cloud Functions podem marcar como processado
  allow update: if request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['processed', 'processedAt']);
  
  /// üóëÔ∏è DELETE:
  /// - N√£o permitido (auditoria)
  allow delete: if false;
}

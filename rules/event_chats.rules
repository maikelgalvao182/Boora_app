/// ğŸ’¬ ColeÃ§Ã£o de chats de eventos (multiusuÃ¡rio)
/// Path usado no app:
/// - EventChats/{eventId}
///   - eventId: string
///   - createdBy: string
///   - createdAt: timestamp
///   - lastMessage: string
///   - lastMessageAt: timestamp
///   - lastMessageSenderId: string
///   - participantIds: array<string>
///   - participantCount: number

match /EventChats/{eventId} {
  // Helper para verificar se Ã© o criador do evento
  function isEventCreator() {
    let event = get(/databases/$(database)/documents/events/$(eventId));
    return event.data.createdBy == request.auth.uid;
  }
  
  // Qualquer participante aprovado pode ler o chat
  allow read: if isSignedIn() && 
    request.auth.uid in resource.data.participantIds;
  
  // Apenas Cloud Functions podem criar/atualizar o documento principal
  allow create, update: if false;
  
  // âœ… O criador do evento pode deletar o chat
  allow delete: if isSignedIn() && isEventCreator();

  /// ğŸ’¬ Mensagens dentro do chat
  match /Messages/{messageId} {
    // Helper: verifica se usuÃ¡rio Ã© participante do evento
    function isParticipant() {
      return request.auth.uid in get(/databases/$(database)/documents/EventChats/$(eventId)).data.participantIds;
    }
    
    // Helper: verifica se Ã© o criador do evento
    function isEventCreator() {
      let event = get(/databases/$(database)/documents/events/$(eventId));
      return event.data.createdBy == request.auth.uid;
    }
    
    /// ğŸ“– LEITURA:
    /// - Qualquer participante pode ler mensagens
    /// - Criador do evento pode ler (para deletar ao excluir evento)
    allow read: if isSignedIn() && (isParticipant() || isEventCreator());
    
    /// âœï¸ CRIAR mensagem:
    /// - Participante autenticado
    /// - sender_id deve ser o usuÃ¡rio autenticado
    /// - Validar campos obrigatÃ³rios
    /// - Validar tipo de mensagem permitido
    /// - Limitar tamanho de mensagem (se aplicÃ¡vel)
    allow create: if isSignedIn() && 
      isParticipant() &&
      request.resource.data.sender_id == request.auth.uid &&
      request.resource.data.keys().hasAll(['sender_id', 'message_type', 'timestamp']) &&
      request.resource.data.message_type in ['text', 'image', 'location', 'audio'];
    
    /// âŒ UPDATE: Mensagens sÃ£o imutÃ¡veis (nÃ£o pode editar)
    allow update: if false;
    
    /// âœ… DELETE: Apenas o criador do evento pode deletar mensagens (ao deletar o evento)
    allow delete: if isSignedIn() && isEventCreator();
  }

  /// ğŸ‘¥ Participantes do chat
  match /Participants/{userId} {
    /// ğŸ“– LEITURA:
    /// - Cada participante pode ler todos os outros
    allow read: if isSignedIn() && 
      request.auth.uid in get(/databases/$(database)/documents/EventChats/$(eventId)).data.participantIds;
    
    /// âœï¸ ATUALIZAR:
    /// - Cada participante pode atualizar APENAS seu prÃ³prio documento
    /// - SÃ³ pode mudar campos de leitura (lastReadAt, unreadCount)
    /// - NÃ£o pode mudar identificadores ou status
    allow update: if isSignedIn() && 
      request.auth.uid == userId &&
      request.auth.uid in get(/databases/$(database)/documents/EventChats/$(eventId)).data.participantIds &&
      request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['lastReadAt', 'unreadCount']);
    
    /// âŒ CREATE/DELETE:
    /// - Apenas Cloud Functions podem criar/deletar participantes
    allow create, delete: if false;
  }
}

/// ğŸ’¬ ColeÃ§Ã£o de chats de eventos (multiusuÃ¡rio)
/// Path usado no app:
/// - EventChats/{eventId}
///   - eventId: string
///   - createdBy: string
///   - createdAt: timestamp
///   - lastMessage: string
///   - lastMessageAt: timestamp
///   - lastMessageSenderId: string
///   - participantIds: array<string>
///   - participantCount: number

match /EventChats/{eventId} {
  // Qualquer participante aprovado pode ler o chat
  allow read: if isSignedIn() && 
    request.auth.uid in resource.data.participantIds;
  
  // Apenas Cloud Functions podem criar/atualizar o documento principal
  allow write: if false;

  /// ğŸ’¬ Mensagens dentro do chat
  match /Messages/{messageId} {
    // Helper: verifica se usuÃ¡rio Ã© participante do evento
    function isParticipant() {
      return request.auth.uid in get(/databases/$(database)/documents/EventChats/$(eventId)).data.participantIds;
    }
    
    // Qualquer participante pode ler mensagens
    allow read: if isSignedIn() && isParticipant();
    
    // Qualquer participante pode criar mensagens (validaÃ§Ã£o forte de sender_id)
    allow create: if isSignedIn() && 
      isParticipant() &&
      request.resource.data.sender_id == request.auth.uid &&
      request.resource.data.keys().hasAll(['sender_id', 'message_type', 'timestamp']);
    
    // NÃ£o pode editar/deletar mensagens
    allow update, delete: if false;
  }

  /// ğŸ‘¥ Participantes do chat
  match /Participants/{userId} {
    // Cada participante pode ler todos os outros
    allow read: if isSignedIn() && 
      request.auth.uid in get(/databases/$(database)/documents/EventChats/$(eventId)).data.participantIds;
    
    // Cada participante pode atualizar apenas seu prÃ³prio documento (lastReadAt, unreadCount)
    allow update: if isSignedIn() && 
      request.auth.uid == userId &&
      request.auth.uid in get(/databases/$(database)/documents/EventChats/$(eventId)).data.participantIds;
    
    // Apenas Cloud Functions podem criar/deletar participantes
    allow create, delete: if false;
  }
}

/// üñºÔ∏è Feed de fotos de eventos (Event Photo Feed)
/// Path usado no app:
/// - EventPhotos/{photoId}
///   - userId: string
///   - status: string ('under_review' | 'active' | 'hidden_by_reports' | 'hidden_by_moderation')
///   - createdAt: timestamp
///   - eventId: string
///   - eventCityId: string
///   - commentsCount: number
///   - likesCount: number
///
/// Subcole√ß√µes:
/// - EventPhotos/{photoId}/comments/{commentId}
/// - EventPhotos/{photoId}/likes/{userId}

function _isOwnerByUserId(userId) {
  return isSignedIn() && request.auth.uid == userId;
}

function _isActivePhoto() {
  return resource.data.status == 'active';
}

function _isOwnPendingReviewPhoto() {
  return isSignedIn() &&
    resource.data.status == 'under_review' &&
    resource.data.userId == request.auth.uid;
}

function _isFeedReadable() {
  return isSignedIn() && (_isActivePhoto() || _isOwnPendingReviewPhoto());
}

match /EventPhotos/{photoId} {
  // üìñ LEITURA:
  // - autenticado pode ler fotos ativas
  // - autor pode ler suas fotos em an√°lise (under_review)
  allow read: if _isFeedReadable();

  // ‚úçÔ∏è CRIAR:
  // - apenas autenticado
  // - userId deve ser o pr√≥prio
  // - status deve iniciar em active ou under_review
  allow create: if isSignedIn() &&
    request.resource.data.userId == request.auth.uid &&
    request.resource.data.status in ['active', 'under_review'];

  // ‚úèÔ∏è UPDATE:
  // - autor pode atualizar
  // - usu√°rios autenticados podem atualizar apenas contadores (comments/likes)
  // - bloqueia mudan√ßa de userId
  // - bloqueia promover status para active pelo client
  allow update: if isSignedIn() && (
    (
      resource.data.userId == request.auth.uid &&
      request.resource.data.userId == request.auth.uid &&
      !(request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']))
    )
    ||
    (
      request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['commentsCount', 'likesCount'])
    )
  );

  // üóëÔ∏è DELETE:
  // - s√≥ autor
  allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;

  // üí¨ Coment√°rios
  match /comments/{commentId} {
    allow read: if isSignedIn() && (
      get(/databases/$(database)/documents/EventPhotos/$(photoId)).data.status == 'active' ||
      (
        get(/databases/$(database)/documents/EventPhotos/$(photoId)).data.status == 'under_review' &&
        get(/databases/$(database)/documents/EventPhotos/$(photoId)).data.userId == request.auth.uid
      )
    );

    // criar coment√°rio:
    // - userId do coment√°rio precisa ser o pr√≥prio
    // - status inicia active (o app lista comments onde status==active)
    allow create: if isSignedIn() &&
      request.resource.data.userId == request.auth.uid &&
      request.resource.data.status == 'active';

    // update/delete: s√≥ autor do coment√°rio
    allow update, delete: if isSignedIn() &&
      resource.data.userId == request.auth.uid;

    // üßµ Replies (thread)
    match /replies/{replyId} {
      allow read: if isSignedIn() && (
        get(/databases/$(database)/documents/EventPhotos/$(photoId)).data.status == 'active' ||
        (
          get(/databases/$(database)/documents/EventPhotos/$(photoId)).data.status == 'under_review' &&
          get(/databases/$(database)/documents/EventPhotos/$(photoId)).data.userId == request.auth.uid
        )
      );

      // criar reply:
      // - userId do reply precisa ser o pr√≥prio
      // - status inicia active
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == 'active' &&
  request.resource.data.commentId == commentId &&
  request.resource.data.photoId == photoId;

      // update/delete: s√≥ autor do reply
      allow update, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }
  }

  // ‚ù§Ô∏è Likes
  match /likes/{userId} {
    allow read: if isSignedIn();
    allow create, delete: if _isOwnerByUserId(userId);
    allow update: if false;
  }
}

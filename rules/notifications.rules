/// üîî Cole√ß√£o de notifica√ß√µes (root collection)
/// Path usado no app:
/// - Notifications/{notificationId}
///   - userId: string (quem recebe - campo principal)
///   - n_receiver_id: string (campo duplicado para compatibilidade - legacy)
///   - n_type: string
///   - n_sender_id: string
///   - n_sender_fullname: string
///   - n_sender_photo_url: string
///   - n_params: map
///   - n_metadata: map
///   - n_related_id: string
///   - n_read: bool
///   - timestamp: timestamp
///
/// üîí SEGURAN√áA:
/// - Apenas o sender pode criar notifica√ß√µes (validando n_sender_id)
/// - Apenas o receiver pode atualizar (marcar como lida) e deletar
/// - Cloud Functions podem criar notifica√ß√µes via Admin SDK

match /Notifications/{notificationId} {
  /// üìñ LEITURA:
  /// - Apenas o destinat√°rio pode ler suas notifica√ß√µes
  allow read: if isSignedIn() && 
    (resource.data.userId == request.auth.uid || resource.data.n_receiver_id == request.auth.uid);
  
  /// ‚úçÔ∏è CRIAR notifica√ß√£o:
  /// - Usu√°rio autenticado pode criar APENAS se for o sender
  /// - n_sender_id deve corresponder ao usu√°rio autenticado
  /// - Validar campos obrigat√≥rios
  /// - userId/n_receiver_id n√£o pode ser o pr√≥prio sender (evitar auto-notifica√ß√£o falsa)
  allow create: if isSignedIn() && 
    request.resource.data.n_sender_id == request.auth.uid &&
    request.resource.data.keys().hasAll(['userId', 'n_type', 'n_sender_id', 'timestamp']) &&
    request.resource.data.userId != request.auth.uid &&
    request.resource.data.n_receiver_id != request.auth.uid;
  
  /// ‚úèÔ∏è ATUALIZAR notifica√ß√£o:
  /// - Apenas o destinat√°rio pode atualizar (ex: marcar como lida)
  /// - S√≥ pode mudar n_read (n√£o pode alterar conte√∫do ou sender)
  allow update: if isSignedIn() && 
    (resource.data.userId == request.auth.uid || resource.data.n_receiver_id == request.auth.uid) &&
    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['n_read']);
  
  /// üóëÔ∏è DELETAR notifica√ß√£o:
  /// - Destinat√°rio pode deletar (limpar hist√≥rico)
  /// - Remetente pode deletar (cancelar invite ou limpar rastro de evento deletado)
  allow delete: if isSignedIn() && 
    (resource.data.userId == request.auth.uid || 
     resource.data.n_receiver_id == request.auth.uid ||
     resource.data.n_sender_id == request.auth.uid);
}

/// üëÅÔ∏è Cole√ß√£o de visitas ao perfil (root level para suporte TTL)
/// Path: ProfileVisits/{visitId}
/// 
/// Estrutura:
/// - visitedUserId: string (quem recebeu a visita)
/// - visitorId: string (quem visitou)
/// - visitedAt: timestamp
/// - visitCount: number (incrementa em visitas repetidas)
/// - expireAt: timestamp (TTL - 7 dias)
/// - source: string ('profile', 'event', etc)
///
/// üîí SEGURAN√áA VIP:
/// - Leitura: apenas VIPs podem ver quem visitou seu perfil
/// - Escrita: apenas o visitor pode registrar sua pr√≥pria visita

match /ProfileVisits/{visitId} {
  /// üìñ LEITURA (get/list - ver detalhes das visitas): 
  /// - Apenas VIP pode ver QUEM visitou seu perfil
  allow get, list: if isSignedIn() && 
                      request.auth.uid == resource.data.visitedUserId &&
                      isVip(request.auth.uid);
  
  /// ‚úçÔ∏è CRIAR visita:
  /// - Usu√°rio autenticado
  /// - visitorId DEVE ser o usu√°rio autenticado (n√£o pode falsificar visitas)
  /// - Validar campos obrigat√≥rios
  /// - N√£o pode visitar o pr√≥prio perfil
  allow create: if isSignedIn() &&
                   request.resource.data.visitorId == request.auth.uid &&
                   request.resource.data.visitedUserId != request.auth.uid &&
                   request.resource.data.keys().hasAll(['visitedUserId', 'visitorId', 'visitedAt']);
  
  /// ‚úèÔ∏è ATUALIZAR visita:
  /// - Apenas o visitor pode atualizar sua pr√≥pria visita (incrementar visitCount)
  /// - N√£o pode mudar visitedUserId ou visitorId
  allow update: if isSignedIn() &&
                   resource.data.visitorId == request.auth.uid &&
                   request.resource.data.visitedUserId == resource.data.visitedUserId &&
                   request.resource.data.visitorId == resource.data.visitorId;
  
  /// üóëÔ∏è DELETE: 
  /// - Apenas o dono do perfil pode deletar visitas recebidas
  allow delete: if isSignedIn() && 
                   request.auth.uid == resource.data.visitedUserId;
}

/// üëÅÔ∏è Cole√ß√£o de views agregadas (para notifica√ß√µes)
/// Path: ProfileViews/{viewId}
match /ProfileViews/{viewId} {
  /// ‚úçÔ∏è CRIAR view:
  /// - Usu√°rio autenticado
  /// - viewerId DEVE ser o usu√°rio autenticado
  /// - Validar campos obrigat√≥rios
  allow create: if isSignedIn() &&
                   request.resource.data.viewerId == request.auth.uid &&
                   request.resource.data.keys().hasAll(['viewedUserId', 'viewerId', 'viewedAt']);
  
  /// üìñ LEITURA:
  /// - Apenas o dono do perfil visualizado pode ler
  allow read: if isSignedIn() && 
                 request.auth.uid == resource.data.viewedUserId;
  
  /// üóëÔ∏è DELETE/UPDATE: n√£o permitido
  allow update, delete: if false;
}
